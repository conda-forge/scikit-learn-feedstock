From 9dd3b54f8720939e59887921f78a67c8c1bc127c Mon Sep 17 00:00:00 2001
From: Gregory Lee <grlee77@gmail.com>
Date: Sun, 26 Apr 2020 19:22:04 -0400
Subject: [PATCH] consistently call import_array() after cimport of numpy

---
 sklearn/_isotonic.pyx                                         | 2 ++
 sklearn/cluster/_dbscan_inner.pyx                             | 2 ++
 sklearn/ensemble/_hist_gradient_boosting/_binning.pyx         | 3 +++
 .../ensemble/_hist_gradient_boosting/_gradient_boosting.pyx   | 2 ++
 sklearn/ensemble/_hist_gradient_boosting/_loss.pyx            | 2 ++
 sklearn/ensemble/_hist_gradient_boosting/_predictor.pyx       | 2 ++
 sklearn/ensemble/_hist_gradient_boosting/common.pxd           | 2 ++
 sklearn/ensemble/_hist_gradient_boosting/histogram.pyx        | 2 ++
 sklearn/ensemble/_hist_gradient_boosting/splitting.pyx        | 4 +++-
 sklearn/linear_model/_sag_fast.pyx.tp                         | 1 +
 sklearn/manifold/_barnes_hut_tsne.pyx                         | 2 ++
 sklearn/manifold/_utils.pyx                                   | 4 ++++
 sklearn/neighbors/_typedefs.pyx                               | 3 +++
 sklearn/preprocessing/_csr_polynomial_expansion.pyx           | 1 +
 sklearn/svm/_libsvm_sparse.pyx                                | 4 +++-
 sklearn/utils/_logistic_sigmoid.pyx                           | 1 +
 16 files changed, 35 insertions(+), 2 deletions(-)

diff --git a/sklearn/_isotonic.pyx b/sklearn/_isotonic.pyx
index c7486097df85..75c4bbef1137 100644
--- a/sklearn/_isotonic.pyx
+++ b/sklearn/_isotonic.pyx
@@ -11,6 +11,8 @@ cimport numpy as np
 cimport cython
 from cython cimport floating
 
+np.import_array()
+
 
 def _inplace_contiguous_isotonic_regression(floating[::1] y, floating[::1] w):
     cdef:
diff --git a/sklearn/cluster/_dbscan_inner.pyx b/sklearn/cluster/_dbscan_inner.pyx
index a348bf59d671..b9a80686a76f 100644
--- a/sklearn/cluster/_dbscan_inner.pyx
+++ b/sklearn/cluster/_dbscan_inner.pyx
@@ -9,6 +9,8 @@ from libcpp.vector cimport vector
 cimport numpy as np
 import numpy as np
 
+np.import_array()
+
 
 # Work around Cython bug: C++ exceptions are not caught unless thrown within
 # a cdef function with an "except +" declaration.
diff --git a/sklearn/ensemble/_hist_gradient_boosting/_binning.pyx b/sklearn/ensemble/_hist_gradient_boosting/_binning.pyx
index 1ecee3c9ee27..4e11abfcabdf 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/_binning.pyx
+++ b/sklearn/ensemble/_hist_gradient_boosting/_binning.pyx
@@ -16,6 +16,9 @@ from libc.math cimport isnan
 
 from .common cimport X_DTYPE_C, X_BINNED_DTYPE_C
 
+np.import_array()
+
+
 def _map_to_bins(const X_DTYPE_C [:, :] data,
                  list binning_thresholds,
                  const unsigned char missing_values_bin_idx,
diff --git a/sklearn/ensemble/_hist_gradient_boosting/_gradient_boosting.pyx b/sklearn/ensemble/_hist_gradient_boosting/_gradient_boosting.pyx
index 8d307c380653..18f1b6a36542 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/_gradient_boosting.pyx
+++ b/sklearn/ensemble/_hist_gradient_boosting/_gradient_boosting.pyx
@@ -13,6 +13,8 @@ cimport numpy as np
 from .common import Y_DTYPE
 from .common cimport Y_DTYPE_C
 
+np.import_array()
+
 
 def _update_raw_predictions(
         Y_DTYPE_C [::1] raw_predictions,  # OUT
diff --git a/sklearn/ensemble/_hist_gradient_boosting/_loss.pyx b/sklearn/ensemble/_hist_gradient_boosting/_loss.pyx
index 64480911439e..4114cd24aa8d 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/_loss.pyx
+++ b/sklearn/ensemble/_hist_gradient_boosting/_loss.pyx
@@ -15,6 +15,8 @@ from libc.math cimport exp, log
 from .common cimport Y_DTYPE_C
 from .common cimport G_H_DTYPE_C
 
+np.import_array()
+
 
 def _update_gradients_least_squares(
         G_H_DTYPE_C [::1] gradients,  # OUT
diff --git a/sklearn/ensemble/_hist_gradient_boosting/_predictor.pyx b/sklearn/ensemble/_hist_gradient_boosting/_predictor.pyx
index b3234cb5ba94..d346aabdac07 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/_predictor.pyx
+++ b/sklearn/ensemble/_hist_gradient_boosting/_predictor.pyx
@@ -18,6 +18,8 @@ from .common import Y_DTYPE
 from .common cimport X_BINNED_DTYPE_C
 from .common cimport node_struct
 
+np.import_array()
+
 
 def _predict_from_numeric_data(
         node_struct [:] nodes,
diff --git a/sklearn/ensemble/_hist_gradient_boosting/common.pxd b/sklearn/ensemble/_hist_gradient_boosting/common.pxd
index 60399c2fbdd7..161ad114829f 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/common.pxd
+++ b/sklearn/ensemble/_hist_gradient_boosting/common.pxd
@@ -2,6 +2,8 @@
 import numpy as np
 cimport numpy as np
 
+np.import_array()
+
 
 ctypedef np.npy_float64 X_DTYPE_C
 ctypedef np.npy_uint8 X_BINNED_DTYPE_C
diff --git a/sklearn/ensemble/_hist_gradient_boosting/histogram.pyx b/sklearn/ensemble/_hist_gradient_boosting/histogram.pyx
index 740e5e002cf4..8bd7c4ee8b35 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/histogram.pyx
+++ b/sklearn/ensemble/_hist_gradient_boosting/histogram.pyx
@@ -17,6 +17,8 @@ from .common cimport hist_struct
 from .common cimport X_BINNED_DTYPE_C
 from .common cimport G_H_DTYPE_C
 
+np.import_array()
+
 # Notes:
 # - IN views are read-only, OUT views are write-only
 # - In a lot of functions here, we pass feature_idx and the whole 2d
diff --git a/sklearn/ensemble/_hist_gradient_boosting/splitting.pyx b/sklearn/ensemble/_hist_gradient_boosting/splitting.pyx
index 43405551ef35..984cc6767fac 100644
--- a/sklearn/ensemble/_hist_gradient_boosting/splitting.pyx
+++ b/sklearn/ensemble/_hist_gradient_boosting/splitting.pyx
@@ -27,6 +27,8 @@ from .common cimport hist_struct
 from .common import HISTOGRAM_DTYPE
 from .common cimport MonotonicConstraint
 
+np.import_array()
+
 
 cdef struct split_info_struct:
     # Same as the SplitInfo class, but we need a C struct to use it in the
@@ -809,7 +811,7 @@ cpdef inline Y_DTYPE_C compute_node_value(
     """
 
     cdef:
-        Y_DTYPE_C value 
+        Y_DTYPE_C value
 
     value = -sum_gradient / (sum_hessian + l2_regularization + 1e-15)
 
diff --git a/sklearn/linear_model/_sag_fast.pyx.tp b/sklearn/linear_model/_sag_fast.pyx.tp
index 5758a8e5ee34..141890497fcd 100644
--- a/sklearn/linear_model/_sag_fast.pyx.tp
+++ b/sklearn/linear_model/_sag_fast.pyx.tp
@@ -58,6 +58,7 @@ from ..utils._seq_dataset cimport SequentialDataset32, SequentialDataset64
 
 from libc.stdio cimport printf
 
+np.import_array()
 
 
 {{for name, c_type, np_type in get_dispatch(dtypes)}}
diff --git a/sklearn/manifold/_barnes_hut_tsne.pyx b/sklearn/manifold/_barnes_hut_tsne.pyx
index ec80890fd8a5..b15462e59768 100644
--- a/sklearn/manifold/_barnes_hut_tsne.pyx
+++ b/sklearn/manifold/_barnes_hut_tsne.pyx
@@ -18,6 +18,8 @@ from cython.parallel cimport prange, parallel
 
 from ..neighbors._quad_tree cimport _QuadTree
 
+np.import_array()
+
 
 cdef char* EMPTY_STRING = ""
 
diff --git a/sklearn/manifold/_utils.pyx b/sklearn/manifold/_utils.pyx
index 676d3676fb8c..0cc2b0af137c 100644
--- a/sklearn/manifold/_utils.pyx
+++ b/sklearn/manifold/_utils.pyx
@@ -5,6 +5,10 @@ cimport cython
 import numpy as np
 cimport numpy as np
 from libc.stdio cimport printf
+
+np.import_array()
+
+
 cdef extern from "numpy/npy_math.h":
     float NPY_INFINITY
 
diff --git a/sklearn/neighbors/_typedefs.pyx b/sklearn/neighbors/_typedefs.pyx
index bbdfd00505b4..789afb4997dd 100644
--- a/sklearn/neighbors/_typedefs.pyx
+++ b/sklearn/neighbors/_typedefs.pyx
@@ -4,6 +4,9 @@ import numpy as np
 cimport numpy as np
 from libc.math cimport sqrt
 
+np.import_array()
+
+
 # use a hack to determine the associated numpy data types
 # NOTE: the following requires the buffer interface, only available in
 #       numpy 1.5+.  We'll choose the DTYPE by hand instead.
diff --git a/sklearn/preprocessing/_csr_polynomial_expansion.pyx b/sklearn/preprocessing/_csr_polynomial_expansion.pyx
index dd36f8321410..84fef3f042dc 100644
--- a/sklearn/preprocessing/_csr_polynomial_expansion.pyx
+++ b/sklearn/preprocessing/_csr_polynomial_expansion.pyx
@@ -8,6 +8,7 @@ from scipy.sparse import csr_matrix
 from numpy cimport ndarray
 cimport numpy as np
 
+np.import_array()
 ctypedef np.int32_t INDEX_T
 
 ctypedef fused DATA_T:
diff --git a/sklearn/svm/_libsvm_sparse.pyx b/sklearn/svm/_libsvm_sparse.pyx
index f180560f1d1e..4b5070a64aad 100644
--- a/sklearn/svm/_libsvm_sparse.pyx
+++ b/sklearn/svm/_libsvm_sparse.pyx
@@ -4,6 +4,8 @@ cimport numpy as np
 from scipy import sparse
 from ..exceptions import ConvergenceWarning
 
+np.import_array()
+
 
 cdef extern from *:
     ctypedef char* const_char_p "const char*"
@@ -186,7 +188,7 @@ def libsvm_sparse_train ( int n_features,
 
     # copy model.nSV
     # TODO: do only in classification
-    cdef np.ndarray n_class_SV 
+    cdef np.ndarray n_class_SV
     n_class_SV = np.empty(n_class, dtype=np.int32)
     copy_nSV(n_class_SV.data, model)
 
diff --git a/sklearn/utils/_logistic_sigmoid.pyx b/sklearn/utils/_logistic_sigmoid.pyx
index 4ca32193c5ce..3531d99bc4f4 100644
--- a/sklearn/utils/_logistic_sigmoid.pyx
+++ b/sklearn/utils/_logistic_sigmoid.pyx
@@ -7,6 +7,7 @@ from libc.math cimport log, exp
 import numpy as np
 cimport numpy as np
 
+np.import_array()
 ctypedef np.float64_t DTYPE_t
 
 
